<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Complaints â€“ GrievEase</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
    <!-- Top Nav -->
    <nav class="nav">
        <div class="nav-brand">
            <button class="hamburger" id="hamburger" aria-label="Menu"><span></span><span></span><span></span></button>
            <div class="nav-brand-logo">ğŸ“</div>
            <span class="nav-brand-name">GrievEase</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <div class="notif-btn" style="position:relative;">
                <button class="btn btn-secondary btn-sm" id="notifBtn" onclick="toggleNotifPanel()"
                    aria-label="Notifications">
                    <i class="fas fa-bell"></i>
                    <span id="notifCount"
                        style="display:none;position:absolute;top:-4px;right:-4px;background:var(--danger);color:white;font-size:0.65rem;font-weight:700;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;"></span>
                </button>
                <div class="notif-panel hidden" id="notifPanel">
                    <div class="notif-header">
                        <span style="font-weight:600;font-size:0.9rem;">Notifications</span>
                        <button onclick="markAllNotifRead()" class="btn btn-sm"
                            style="font-size:0.75rem;padding:4px 10px;background:transparent;color:var(--primary-light);">Mark
                            all read</button>
                    </div>
                    <div class="notif-list" id="notifList">
                        <div style="padding:24px;text-align:center;color:var(--text-muted);">Loading...</div>
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt"></i>
                Logout</button>
        </div>
    </nav>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-chip">
                    <div class="user-avatar" id="sidebarAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarUserName">Student</div>
                        <div class="user-role" id="sidebarUserRole">student</div>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section-title">Student Portal</div>
                <a href="/student-dashboard.html" class="sidebar-link active"><i class="fas fa-tachometer-alt"></i>
                    Dashboard</a>
                <a href="/submit-complaint.html" class="sidebar-link"><i class="fas fa-plus-circle"></i> New
                    Complaint</a>
                <div class="sidebar-section-title" style="margin-top:16px;">Complaints</div>
                <a href="#" class="sidebar-link" id="filterAll" onclick="setFilter('all')"><i class="fas fa-list"></i>
                    All Complaints</a>
                <a href="#" class="sidebar-link" id="filterPending" onclick="setFilter('Pending')"><i
                        class="fas fa-clock"></i> Pending</a>
                <a href="#" class="sidebar-link" id="filterProgress" onclick="setFilter('In Progress')"><i
                        class="fas fa-spinner"></i> In Progress</a>
                <a href="#" class="sidebar-link" id="filterResolved" onclick="setFilter('Resolved')"><i
                        class="fas fa-check-circle"></i> Resolved</a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn btn-secondary btn-full btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt"></i>
                    Sign Out</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header flex-between" style="flex-wrap:wrap;gap:16px;">
                <div>
                    <h1 class="page-title">My Dashboard</h1>
                    <p class="page-subtitle">Track and manage your submitted complaints</p>
                </div>
                <a href="/submit-complaint.html" class="btn btn-primary"><i class="fas fa-plus"></i> Submit
                    Complaint</a>
            </div>

            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon stat-icon-blue"><i class="fas fa-list-ul"></i></div>
                    <div>
                        <div class="stat-value" id="statTotal">â€“</div>
                        <div class="stat-label">Total Complaints</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon stat-icon-yellow"><i class="fas fa-clock"></i></div>
                    <div>
                        <div class="stat-value" id="statPending">â€“</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon stat-icon-blue"><i class="fas fa-spinner"></i></div>
                    <div>
                        <div class="stat-value" id="statProgress">â€“</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon stat-icon-green"><i class="fas fa-check-circle"></i></div>
                    <div>
                        <div class="stat-value" id="statResolved">â€“</div>
                        <div class="stat-label">Resolved</div>
                    </div>
                </div>
            </div>

            <!-- Complaints List -->
            <div class="table-container">
                <div class="table-header">
                    <span class="table-title" id="listTitle">All Complaints</span>
                    <div class="search-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search complaints..."
                            oninput="filterComplaints()" />
                    </div>
                </div>
                <div id="complaintsList" style="padding:0 var(--space-md) var(--space-md);">
                    <!-- Skeleton loading -->
                    <div style="padding:var(--space-md);">
                        <div class="skeleton skeleton-title" style="margin-bottom:8px;"></div>
                        <div class="skeleton skeleton-text" style="width:80%;"></div>
                        <div class="skeleton skeleton-text" style="width:60%;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="/js/utils.js"></script>
    <script>
        let allComplaints = [];
        let currentFilter = 'all';

        async function init() {
            const user = requireAuth(['student']);
            if (!user) return;
            initSidebar();
            await Promise.all([loadComplaints(), loadNotifications()]);
        }

        async function loadComplaints() {
            try {
                const data = await apiGet('/api/complaints');
                allComplaints = data.complaints || [];
                updateStats();
                renderComplaints(allComplaints);
            } catch (err) {
                document.getElementById('complaintsList').innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><h3>Failed to load complaints</h3><p>${err.message}</p></div>`;
            }
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = allComplaints.length;
            document.getElementById('statPending').textContent = allComplaints.filter(c => c.status === 'Pending').length;
            document.getElementById('statProgress').textContent = allComplaints.filter(c => c.status === 'In Progress').length;
            document.getElementById('statResolved').textContent = allComplaints.filter(c => c.status === 'Resolved').length;
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.sidebar-link[id^=filter]').forEach(el => el.classList.remove('active'));
            document.getElementById(`filter${filter === 'all' ? 'All' : filter.replace(' ', '')}`).classList.add('active');
            const titles = { all: 'All Complaints', Pending: 'Pending Complaints', 'In Progress': 'In Progress', Resolved: 'Resolved Complaints' };
            document.getElementById('listTitle').textContent = titles[filter];
            filterComplaints();
        }

        function filterComplaints() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allComplaints;
            if (currentFilter !== 'all') filtered = filtered.filter(c => c.status === currentFilter);
            if (search) filtered = filtered.filter(c => c.title.toLowerCase().includes(search) || c.description.toLowerCase().includes(search) || c.category.toLowerCase().includes(search));
            renderComplaints(filtered);
        }

        function renderComplaints(complaints) {
            const container = document.getElementById('complaintsList');
            if (!complaints.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><h3>No complaints found</h3><p>Submit your first complaint using the button above.</p><a href="/submit-complaint.html" class="btn btn-primary" style="margin-top:16px;"><i class="fas fa-plus"></i> Submit Complaint</a></div>`;
                return;
            }
            container.innerHTML = `<div class="complaints-grid" style="padding:var(--space-md) 0;">
        ${complaints.map(c => `
          <div class="complaint-card priority-${c.priority.toLowerCase()}" onclick="window.location.href='/complaint-detail.html?id=${c.id}'">
            <div class="complaint-card-header">
              <div class="complaint-title">${escapeHtml(c.title)}</div>
              <div class="complaint-badges">${statusBadge(c.status)} ${priorityBadge(c.priority)}</div>
            </div>
            <p class="complaint-desc">${escapeHtml(c.description)}</p>
            <div class="complaint-meta">
              <span><i class="fas fa-tag"></i> ${c.category}</span>
              <span><i class="fas fa-building"></i> ${c.assigned_dept || 'N/A'}</span>
              <span><i class="fas fa-clock"></i> ${timeAgo(c.created_at)}</span>
              ${c.sentiment_label ? `<span>${getSentimentEmoji(c.sentiment_label)} ${c.sentiment_label}</span>` : ''}
              ${c.image_path ? '<span><i class="fas fa-image"></i> Image attached</span>' : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
        }

        function getSentimentEmoji(label) {
            const map = { 'Very Negative': 'ğŸ˜¡', 'Negative': 'ğŸ˜', 'Neutral': 'ğŸ˜', 'Positive': 'ğŸ™‚', 'Very Positive': 'ğŸ˜Š' };
            return map[label] || 'ğŸ˜';
        }

        function escapeHtml(str) {
            const d = document.createElement('div'); d.textContent = str; return d.innerHTML;
        }

        init();
    </script>
</body>

</html>