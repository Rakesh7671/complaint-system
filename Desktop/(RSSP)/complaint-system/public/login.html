<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login â€“ GrievEase</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
    <div class="auth-page">
        <div class="auth-container">
            <!-- Hero Side -->
            <div class="auth-hero">
                <div class="auth-hero-icon">ðŸŽ“</div>
                <h2>Welcome Back</h2>
                <p>Sign in to track your complaints and stay updated on their resolution status.</p>
                <div class="auth-hero-features">
                    <div class="auth-hero-feature"><i class="fas fa-brain"></i> AI-powered complaint classification
                    </div>
                    <div class="auth-hero-feature"><i class="fas fa-bell"></i> Real-time status notifications</div>
                    <div class="auth-hero-feature"><i class="fas fa-chart-line"></i> Track resolution progress</div>
                    <div class="auth-hero-feature"><i class="fas fa-shield-alt"></i> Secure and confidential</div>
                </div>
                <!-- Demo credentials -->
                <div style="margin-top:24px;background:rgba(255,255,255,0.1);border-radius:12px;padding:16px;">
                    <p style="color:rgba(255,255,255,0.9);font-size:0.8rem;font-weight:600;margin-bottom:8px;">ðŸ”‘ Demo
                        Accounts</p>
                    <p
                        style="color:rgba(255,255,255,0.7);font-size:0.75rem;margin-bottom:4px;font-family:'JetBrains Mono',monospace;">
                        Student: amit@student.edu</p>
                    <p
                        style="color:rgba(255,255,255,0.7);font-size:0.75rem;margin-bottom:8px;font-family:'JetBrains Mono',monospace;">
                        Super Admin: superadmin@college.edu</p>
                    <p style="color:rgba(255,255,255,0.6);font-size:0.7rem;">All passwords: Admin@123 / Student@123</p>
                </div>
            </div>
            <!-- Form Side -->
            <div class="auth-form-section">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:24px;">
                    <div class="nav-brand-logo">ðŸŽ“</div>
                    <span class="nav-brand-name">GrievEase</span>
                </div>
                <h1 class="auth-form-title">Sign In</h1>
                <p class="auth-form-subtitle">Enter your credentials to access the portal</p>

                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="email">Email Address <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" id="email" name="email" class="form-input input-with-icon"
                                placeholder="you@college.edu" required autocomplete="email" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">Password <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="password" name="password" class="form-input input-with-icon"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password" />
                            <button type="button" id="togglePwd"
                                style="position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;color:var(--text-muted);"
                                aria-label="Toggle password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div id="loginError" class="form-error hidden"><i class="fas fa-exclamation-circle"></i> <span
                            id="loginErrorMsg"></span></div>

                    <button type="submit" id="loginBtn" class="btn btn-primary btn-full btn-lg" style="margin-top:8px;">
                        <i class="fas fa-sign-in-alt"></i> <span>Sign In</span>
                    </button>
                </form>

                <p style="text-align:center;margin-top:24px;font-size:0.875rem;color:var(--text-secondary);">
                    Don't have an account? <a href="/register.html" class="auth-link">Register here</a>
                </p>
                <p style="text-align:center;margin-top:12px;font-size:0.875rem;">
                    <a href="/" class="auth-link"><i class="fas fa-arrow-left"></i> Back to Home</a>
                </p>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="/js/utils.js"></script>
    <script src="/js/auth.js"></script>

    <!-- Firebase SDK (modular via CDN with compatibility shim) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBTD_ZrX-SSd6eVNEWfaB98bHWSNKyRP-E",
            authDomain: "fir-demo-90f79.firebaseapp.com",
            projectId: "fir-demo-90f79",
            storageBucket: "fir-demo-90f79.firebasestorage.app",
            messagingSenderId: "388352631458",
            appId: "1:388352631458:web:400a5769ade1fcf3f4edfb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // â”€â”€ If already logged in via Firebase + have a local JWT, redirect immediately â”€â”€
        onAuthStateChanged(auth, (firebaseUser) => {
            if (firebaseUser && getToken()) {
                const role = getUser()?.role;
                if (role === 'student') window.location.href = '/student-dashboard.html';
                else window.location.href = '/admin-dashboard.html';
            }
        });

        // â”€â”€ Toggle password visibility â”€â”€
        document.getElementById('togglePwd').addEventListener('click', function () {
            const pwd = document.getElementById('password');
            const icon = this.querySelector('i');
            if (pwd.type === 'password') { pwd.type = 'text'; icon.className = 'fas fa-eye-slash'; }
            else { pwd.type = 'password'; icon.className = 'fas fa-eye'; }
        });

        // â”€â”€ Login form submit â”€â”€
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const errDiv = document.getElementById('loginError');
            const errMsg = document.getElementById('loginErrorMsg');
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            errDiv.classList.add('hidden');

            // Helper: finish login via backend JWT
            async function finishWithBackend() {
                const data = await apiPost('/api/auth/login', { email, password });
                saveToken(data.token);
                saveUser(data.user);
                showToast('Welcome back, ' + data.user.name + '!', 'success');
                setTimeout(() => {
                    if (data.user.role === 'student') window.location.href = '/student-dashboard.html';
                    else window.location.href = '/admin-dashboard.html';
                }, 800);
            }

            try {
                // Step 1: Sign in with Firebase
                await signInWithEmailAndPassword(auth, email, password);
                // Step 2: Get role/JWT from backend
                await finishWithBackend();

            } catch (err) {
                // Firebase config not set up yet OR user not in Firebase â†’ fall back to backend
                const firebaseFallbackCodes = [
                    'auth/configuration-not-found',
                    'auth/operation-not-allowed',
                    'auth/user-not-found',
                    'auth/invalid-api-key'
                ];

                if (!err.code || firebaseFallbackCodes.includes(err.code)) {
                    // No Firebase error code means it's a network/backend error, or
                    // Firebase isn't configured â†’ use backend auth only
                    try {
                        await finishWithBackend();
                        return;
                    } catch (backendErr) {
                        errMsg.textContent = backendErr.message || 'Invalid email or password.';
                        errDiv.classList.remove('hidden');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                        return;
                    }
                }

                // Firebase-specific error messages
                let message = 'Login failed. Please try again.';
                if (err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
                    message = 'Invalid email or password.';
                } else if (err.code === 'auth/too-many-requests') {
                    message = 'Too many failed attempts. Please try again later.';
                } else if (err.code === 'auth/network-request-failed') {
                    message = 'Network error. Check your connection and try again.';
                } else if (err.code === 'auth/invalid-email') {
                    message = 'Invalid email address format.';
                }

                errMsg.textContent = message;
                errDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }
        });
    </script>
</body>

</html>